<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Projekt WebGIS - Lublin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        #sidebar {
            width: 350px;
            background: #1e1e24;
            color: #ffffff;
            padding: 30px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            z-index: 2;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow-y: auto;
        }

        #map { flex-grow: 1; }

        h1 { font-size: 22px; font-weight: 600; margin-bottom: 5px; color: #fff; }
        h2 { font-size: 14px; color: #8b9bb4; margin-top: 0; font-weight: 400; text-transform: uppercase; letter-spacing: 1px; }
        h3 { font-size: 13px; margin-bottom: 10px; color: #fff; border-bottom: 1px solid #444; padding-bottom: 5px; }
        p { font-size: 14px; line-height: 1.5; color: #aab2c0; }

        .legend-item { display: flex; align-items: center; margin-bottom: 12px; font-size: 14px; }
        .dot { width: 14px; height: 14px; border-radius: 50%; margin-right: 12px; }
        .dot-station { background: #00ffff; box-shadow: 0 0 8px #00ffff; }
        .dot-range { background: rgba(17, 180, 218, 0.4); border: 1px solid #11b4da; }

        .layer-switcher { margin-top: 20px; background: #2b2b36; padding: 15px; border-radius: 8px; }
        .radio-group { display: flex; flex-direction: column; gap: 8px; }
        .radio-group label { cursor: pointer; font-size: 14px; display: flex; align-items: center; }
        .radio-group input { margin-right: 10px; accent-color: #00ffff; }

        #result-card {
            background: #2b2b36;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #555;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        .status-title { font-weight: 600; font-size: 16px; display: block; margin-bottom: 8px; }
        .status-desc { font-size: 13px; color: #ccc; }
        
        .status-ok { border-color: #27ae60 !important; }
        .text-ok { color: #27ae60; }
        .status-bad { border-color: #e74c3c !important; }
        .text-bad { color: #e74c3c; }

        .footer { font-size: 11px; color: #555; text-align: center; margin-top: 20px; }

        @media (max-width: 600px) {
            body { flex-direction: column; }
            #sidebar { width: auto; height: 40%; padding: 15px; }
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div>
        <h1>Projekt WebGIS</h1>
        <h2>Analiza Infrastruktury Miejskiej</h2>
        <p>Aplikacja wyznacza obszary deficytu ładowarek elektrycznych na terenie miasta Lublin.</p>
        
        <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">

        <div class="legend-item">
            <div class="dot dot-station"></div> Istniejąca stacja
        </div>
        <div class="legend-item">
            <div class="dot dot-range"></div> Strefa pokrycia (1.0 km)
        </div>

        <div class="layer-switcher">
            <h3>Wybierz podkład mapy</h3>
            <div class="radio-group">
                <label>
                    <input type="radio" name="style" value="mapbox://styles/mapbox/dark-v11" checked>
                    Dark (Nocny)
                </label>
                <label>
                    <input type="radio" name="style" value="mapbox://styles/mapbox/satellite-streets-v12">
                    Satelita + Ulice
                </label>
                <label>
                    <input type="radio" name="style" value="mapbox://styles/mapbox/streets-v12">
                    Mapa (Jasna)
                </label>
            </div>
        </div>
    </div>

    <div>
        <div id="result-card">
            <span class="status-title" style="color: #fff;">Gotowy do analizy</span>
            <span class="status-desc">Kliknij w dzielnicę mieszkalną, aby sprawdzić dostępność ładowarki.</span>
        </div>
        <div class="footer">Projekt WebGIS - Politechnika Lubelska / UMCS / UP</div>
    </div>
</div>

<div id="map"></div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYmFkY2lhYiIsImEiOiJjbWpycTMxdzUzcW0wM2ZxeGM3MzJmMHd3In0.x86RM6MyxrwiOKl1GAznxA';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11',
        center: [22.56, 51.24],
        zoom: 12,
        pitch: 45,
        bearing: -10
    });

    map.addControl(new mapboxgl.NavigationControl(), 'top-right');
    map.addControl(new mapboxgl.GeolocateControl({ trackUserLocation: true }), 'top-right');

    let mojeDaneGeoJSON = null; 

    function dodajNaszeWarstwy() {
        if (!mojeDaneGeoJSON) return; 
        if (map.getSource('stacje-source')) return; 

        const PROMIEN_KM = 1.0; 
        const strefyZasiegu = turf.buffer(mojeDaneGeoJSON, PROMIEN_KM, { units: 'kilometers' });

        map.addSource('zasieg-source', { type: 'geojson', data: strefyZasiegu });
        map.addLayer({
            id: 'zasieg-wizualizacja',
            type: 'fill',
            source: 'zasieg-source',
            paint: { 'fill-color': '#11b4da', 'fill-opacity': 0.2, 'fill-outline-color': '#11b4da' }
        });

        map.addSource('stacje-source', { type: 'geojson', data: mojeDaneGeoJSON });
        
        map.addLayer({
            id: 'stacje-glow',
            type: 'circle',
            source: 'stacje-source',
            paint: { 'circle-radius': 15, 'circle-color': '#00ffff', 'circle-opacity': 0.4, 'circle-blur': 0.5 }
        });
        
        map.addLayer({
            id: 'stacje-punkty',
            type: 'circle',
            source: 'stacje-source',
            paint: { 'circle-radius': 6, 'circle-color': '#ffffff' }
        });

        if (!map.getLayer('3d-buildings')) {
            map.addLayer({
                'id': '3d-buildings',
                'source': 'composite',
                'source-layer': 'building',
                'filter': ['==', 'extrude', 'true'],
                'type': 'fill-extrusion',
                'minzoom': 13,
                'paint': {
                    'fill-extrusion-color': '#aaa',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.1
                }
            });
        }
    }

    map.on('load', async () => {
        try {
            const response = await fetch('export.geojson');
            if (!response.ok) throw new Error('Błąd pliku dane.geojson');
            
            const suroweDane = await response.json();

            mojeDaneGeoJSON = {
                type: "FeatureCollection",
                features: suroweDane.features.filter(f => f.geometry.type === 'Point')
            };

            dodajNaszeWarstwy();

            const inputs = document.querySelectorAll('input[name="style"]');
            for (const input of inputs) {
                input.onclick = (layer) => {
                    const wybranyStyl = layer.target.value;
                    map.setStyle(wybranyStyl);
                };
            }

            map.on('style.load', () => {
                dodajNaszeWarstwy();
            });

        } catch (error) {
            console.error(error);
            alert("Błąd: " + error.message);
        }
    });

    let marker = new mapboxgl.Marker({ color: '#f39c12' });

    map.on('click', (e) => {
        if (!mojeDaneGeoJSON) return;

        const klik = turf.point([e.lngLat.lng, e.lngLat.lat]);
        const najblizsza = turf.nearestPoint(klik, mojeDaneGeoJSON);
        const dystans = turf.distance(klik, najblizsza, { units: 'kilometers' });
        
        const nazwaStacji = najblizsza.properties.name || "Stacja bez nazwy";

        marker.setLngLat(e.lngLat).addTo(map);

        const card = document.getElementById('result-card');
        const PROMIEN_KM = 1.0;

        if (dystans < PROMIEN_KM) {
            card.className = "status-bad";
            card.innerHTML = `
                <span class="status-title text-bad">⚠️ Lokalizacja Nieoptymalna</span>
                <span class="status-desc">
                    W zasięgu stacji: <strong>${nazwaStacji}</strong>.<br>
                    Dystans: <strong>${dystans.toFixed(2)} km</strong>
                </span>`;
        } else {
            card.className = "status-ok";
            card.innerHTML = `
                <span class="status-title text-ok">✅ Rekomendacja Pozytywna</span>
                <span class="status-desc">
                    Biała plama.<br>
                    Dystans do najbliższej: <strong>${dystans.toFixed(2)} km</strong>
                </span>`;
        }
    });

    map.getCanvas().style.cursor = 'crosshair';

</script>

</body>
</html>